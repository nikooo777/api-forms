<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="/css/bootstrap.css">
  </head>
  <body>
    <div class="container" style="max-width: 800px">
      <h1>Send Template Emails</h1>

      <div id="alert" class="alert show" style="visibility: hidden;">
        <button type="button" class="close" onclick="$(this).closest('.alert').css('visibility', 'hidden')">
          <span aria-hidden="true">&times;</span>
        </button>
        <div class="alert-content"></div>
      </div>

      <form id="form">
        <div class="form-group mb-4">
          <label>Auth Token</label> <input class="form-control" type=text name="auth_token" />
        </div>

        <div class="form-group mb-4">
          <label>Subject</label> <input class="form-control" type=text name="subject" />
        </div>

        <div class="form-group mb-4">
          <label>Template</label> <input class="form-control" type=text name="template" />
        </div>

        <div class="form-group mb-4">
          <label>Recipients</label>
          <div class="form-check">
            <label class="form-check-label"> <input class="form-check-input" type="radio" name="recipients" value="rewardable" checked>
              Rewardable - users who can claim rewards </label>
          </div>
          <div class="form-check">
            <label class="form-check-label"> <input class="form-check-input" type="radio" name="recipients" value="unclaimed"> Unclaimed -
              users who are reward-eligible but have never claimed a reward (aka never used the app) </label>
          </div>
          <div class="form-check">
            <label class="form-check-label"> <input class="form-check-input" type="radio" name="recipients" value="everyone"> Everyone -
              seriously. Be careful with this one. </label>
          </div>
          <div class="form-check">
            <label class="form-check-label"> <input class="form-check-input" type="radio" name="recipients" value="custom"> Custom </label>
          </div>
          <textarea name="recipients" id="emails" style="width: 100%" placeholder="one@gmail.com,two@gmail.com,..."></textarea>
        </div>

        <div class="form-group mb-4">
          <label>Confirm?</label>

          <div class="form-check">
            <label class="form-check-label"> <input class="form-check-input" type="radio" name="confirm" value="" checked> testing </label>
          </div>
          <div class="form-check">
            <label class="form-check-label"> <input class="form-check-input" type="radio" name="confirm" value="yes"> REALLY SEND IT
            </label>
          </div>
        </div>

        <button type="submit" class="btn btn-primary">Send</button>

      </form>
    </div>

    <!-- jQuery first, then Tether, then Bootstrap JS. -->
    <script src="/js/jquery-3.2.1.js"></script>
    <script src="/js/tether.min.js"></script>
    <script src="/js/bootstrap.js"></script>
    <script>
      $(document).ready(function () {
        var form = $("#form");
        var alert = $("#alert");

        var onChange = function (event) {
          var on = form.find("input[type=radio][name=recipients]:checked").val() != "custom";
          $("#emails").prop("disabled", on).prop("readonly", on);
        };

        form.on("change", "input", onChange);
        onChange();

        form.on("submit", function (event) {
          event.preventDefault();

          alert.css("visibility", "hidden");
          form.find('button[type=submit]').text("Sending...").addClass("disabled");
          form.find("input[name=recipients][value=custom]").prop("disabled", true);

          $.ajax({
            url: 'https://api.lbry.io/template/send',
            type: "POST",
            dataType: 'json',
            data: form.serialize(),
            success: function (result) {
              alert.addClass('alert-success').removeClass("alert-danger").find('.alert-content').text(result.data);
            },
            error: function (xhr, response, text) {
              alert.addClass('alert-danger').removeClass("alert-success").find('.alert-content').text(xhr.responseJSON.error);
            },
            complete: function() {
              alert.css("visibility", "visible")
              form.find('button[type=submit]').text("Send").removeClass("disabled");
              form.find("input[name=recipients][value=custom]").prop("disabled", false);
            },
          })
        });
      });
    </script>
  </body>
</html>
